
# Уязвимость Элжура

## Описание
С помощью уязвимости, которую я опишу здесь, можно выполнить ряд действий, непредусмотренных разработчиками:
* посмотреть оценки любого человека из лицея (ранее можно было видеть только свои оценки)
* написать сообщение как всем лицейским пользователям элжура разом, так выборочно любому человеку (раньше можно было писать только учителям и ученикам параллели)

 ## Как воспроизвести уязвимость 
 Вся суть 'эксплойта' состоит в том, что у каждого пользователя элжура есть свой id. С помощью него можно писать другим пользователям, смотреть оценки и прочее.
Id отдельного пользователя узнать несложно. Он показывается, когда мы отправляем кому-либо сообщение. Id пользователя - параметр receivers в POST-запросе элжуру

![Так выглядит запрос в Элжур](./img/post_eljur.jpg)

С помощью записи/перехвата POST-запроса прокси мы можем найти id одного пользователя. Затем мы можем написать ему сообщение, вставив его id в параметр receivers, или посмотреть его оценки, перейдя по ссылке https://hselyceum.eljur.ru/journal-index-my-studentmarks-action/u.USERID/part./fn.marks?mode=pdf, где USERID - id конкретного пользователя

## Автоматизация уязвимости 
Согласитесь, выискивать id одного пользователя таким образом - очень монотонное занятие. Гораздо удобнее найти список всех id и их владельцев. Такая возможность есть 

Как уже было сказано, id пользователя применяется в сообщениях. Покопавшись на сайте, мы обнаружили, что id всех получателей находится **прямо в html-коде сообщения** 

Было найдено письмо  с примерно 3900 получателями (учащиеся и их родители). Информация о пользователях содержалась в переменной allReceivers


 ```js
var allReceivers =  [
{
uid:  12345,
fio:  'Иванов И.',
full_fio:  'Иванов Иван Иванович',
id:  12345,
firstname:  'Иван',
lastname:  'Иванов',
middlename:  'Иванович',
info:  '',
},

{
uid:  23456,
fio:  'Петров П.',
full_fio:  'Петров Петр Петрович',
id:  23456,
firstname:  'Петр',
lastname:  'Петров',
middlename:  'Петрович',
info:  '',
}]
```
<span style="color:grey">Так выглядит переменная, обнаруженная в html-коде страницы сообщения</span>




С помощью js-программы мы создали два файла, в которых построчно содержались ФИ пользователя и ссылка на его оценки   
Bash-скрипт использует эти два файла, чтобы с помощью wget скачать оценки в указанном формате (csv или pdf)

## Авторизация
Вопрос авторизация касается не только данной уязвимости, но и работе элжура в целом. Как выяснилось, за совершения каких-либо действий в элжуре отвечает всего лишь один файл куки. Он называется session_id

Свойства куки:
* session_id пользователя может быть использован любым другим пользователем, ранее зарегистрированным под другим логино и паролем
*    при выходе из учетной записи старый куки session_id все равно остается валидным
* при смене пароля старый куки session_id все равно остается валидным

При использовании wget для скачивания данных лицеистов потребовался лишь куки session_id. Он хранится в файле eljur.ru_cookies.txt 

## Использование куки session_id
Получение куки гарантирует получение всех прав пользователя-владельца этого файла. Т.е. любой пользователь с куки session_id учителя может менять оценки учеников, писать сообщения от своего имени и прочее 
